#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
用例生成协调器
协调模块选择和用例生成流程
"""

from typing import List, Dict
import streamlit as st
from module import Module
from ai_generator import AIGenerator


class TestCaseCoordinator:
    """用例生成协调器"""
    
    def __init__(self, ai_generator: AIGenerator):
        """
        初始化协调器
        
        Args:
            ai_generator: AI生成器实例
        """
        self.ai_generator = ai_generator
    
    def generate_cases_for_selected(
        self,
        content: str,
        selected_modules: List[Module],
        selected_categories: List[str]
    ) -> List[Dict]:
        """
        为选中的模块生成用例
        
        Args:
            content: 需求文档内容
            selected_modules: 选中的模块列表
            selected_categories: 选中的建议选项列表
            
        Returns:
            用例列表
        """
        if not selected_modules:
            st.warning("⚠️ 请至少选择一个模块")
            return []
        
        all_cases = []
        success_count = 0
        fail_count = 0
        
        # 创建进度条
        progress_bar = st.progress(0)
        status_text = st.empty()
        
        total = len(selected_modules)
        
        for idx, module in enumerate(selected_modules):
            # 更新进度
            progress = (idx + 1) / total
            progress_bar.progress(progress)
            status_text.text(f"正在生成 {module.name} 的用例... ({idx + 1}/{total})")
            
            try:
                # 将Module对象转换为字典格式
                module_dict = {
                    'name': module.name,
                    'description': module.description,
                    'type': module.type
                }
                
                # 调用AI生成器生成用例，传递建议选项
                cases = self.ai_generator.generate_test_cases(
                    content,
                    module_dict,
                    categories=selected_categories
                )
                
                if cases:
                    all_cases.extend(cases)
                    success_count += 1
                else:
                    # 如果AI返回空，使用模板生成
                    template_cases = self.ai_generator._template_cases(module.name, selected_categories)
                    all_cases.extend(template_cases)
                    fail_count += 1
                    st.warning(f"⚠️ {module.name} 生成失败，使用模板生成")
                    
            except Exception as e:
                # 捕获异常，使用模板生成
                fail_count += 1
                st.warning(f"⚠️ {module.name} 生成失败: {str(e)}，使用模板生成")
                template_cases = self.ai_generator._template_cases(module.name, selected_categories)
                all_cases.extend(template_cases)
        
        # 为建议选项生成独立模块的用例
        if selected_categories:
            status_text.text(f"正在为建议选项生成用例...")
            category_cases = self._generate_category_modules(selected_categories)
            all_cases.extend(category_cases)
        
        # 完成进度
        progress_bar.progress(1.0)
        status_text.text(f"✅ 生成完成！成功: {success_count}，失败: {fail_count}")
        
        return all_cases
    
    def _generate_category_modules(self, categories: List[str]) -> List[Dict]:
        """
        为建议选项生成独立模块的用例
        
        Args:
            categories: 建议选项列表
            
        Returns:
            建议选项模块的用例列表
        """
        category_cases = []
        
        # 定义每个建议选项的用例
        category_templates = {
            '全局页面': [
                {
                    '页面/模块': '全局页面',
                    '检查点': '页面头部',
                    '设计原则': '视觉一致性原则',
                    '检查项': '检查页面头部Logo、导航菜单、用户信息等全局元素的样式和布局',
                    '优先级': '高',
                    '预期结果/设计标准': '头部高度64px，Logo尺寸120x32px，导航菜单字号14px，颜色#262626'
                },
                {
                    '页面/模块': '全局页面',
                    '检查点': '页面底部',
                    '设计原则': '视觉一致性原则',
                    '检查项': '检查页面底部版权信息、链接、联系方式等全局元素',
                    '优先级': '中',
                    '预期结果/设计标准': '底部高度48px，文字颜色#999999，字号12px，链接有hover效果'
                },
                {
                    '页面/模块': '全局页面',
                    '检查点': '侧边导航栏',
                    '设计原则': '视觉一致性原则',
                    '检查项': '检查侧边导航栏的菜单项、展开/收起状态、选中状态',
                    '优先级': '高',
                    '预期结果/设计标准': '菜单项高度40px，选中状态有背景色，展开/收起有动画效果'
                },
                {
                    '页面/模块': '全局页面',
                    '检查点': '面包屑导航',
                    '设计原则': '组织有序原则',
                    '检查项': '检查面包屑导航的层级显示、点击跳转功能',
                    '优先级': '中',
                    '预期结果/设计标准': '层级用"/"分隔，当前页不可点击，历史页可点击跳转'
                },
                {
                    '页面/模块': '全局页面',
                    '检查点': '全局提示组件',
                    '设计原则': '交互与反馈原则',
                    '检查项': '检查Toast、Message、Notification等全局提示组件的样式和行为',
                    '优先级': '高',
                    '预期结果/设计标准': 'Toast自动消失时间3秒，位置居中顶部，有淡入淡出动画'
                },
                {
                    '页面/模块': '全局页面',
                    '检查点': '全局加载状态',
                    '设计原则': '交互与反馈原则',
                    '检查项': '检查页面级Loading、骨架屏的显示效果',
                    '优先级': '高',
                    '预期结果/设计标准': 'Loading有旋转动画，骨架屏与实际内容布局一致'
                },
                {
                    '页面/模块': '全局页面',
                    '检查点': '响应式布局',
                    '设计原则': '组织有序原则',
                    '检查项': '检查在不同屏幕尺寸下全局组件的表现',
                    '优先级': '中',
                    '预期结果/设计标准': '移动端导航收起为汉堡菜单，平板和PC端正常显示'
                }
            ],
            '场景流程': [
                {
                    '页面/模块': '场景流程',
                    '检查点': '完整操作流程',
                    '设计原则': '简化交互原则',
                    '检查项': '检查从进入页面到完成目标的完整用户操作路径',
                    '优先级': '高',
                    '预期结果/设计标准': '流程步骤清晰，每步有明确的操作指引和反馈，无断点'
                },
                {
                    '页面/模块': '场景流程',
                    '检查点': '多步骤表单',
                    '设计原则': '简化交互原则',
                    '检查项': '检查多步骤表单的步骤指示器、上一步/下一步按钮、数据保存',
                    '优先级': '高',
                    '预期结果/设计标准': '步骤指示器显示当前步骤，已完成步骤可点击返回，数据自动保存'
                },
                {
                    '页面/模块': '场景流程',
                    '检查点': '向导式流程',
                    '设计原则': '引导与帮助原则',
                    '检查项': '检查向导式流程的引导提示、进度展示、步骤跳转',
                    '优先级': '中',
                    '预期结果/设计标准': '每步有引导文案，进度条显示完成百分比，可跳过非必填步骤'
                },
                {
                    '页面/模块': '场景流程',
                    '检查点': '数据提交流程',
                    '设计原则': '简化交互原则',
                    '检查项': '检查填写→预览→确认→提交→反馈的完整流程',
                    '优先级': '高',
                    '预期结果/设计标准': '预览页显示所有填写内容，确认后提交，提交成功有明确反馈'
                },
                {
                    '页面/模块': '场景流程',
                    '检查点': '审批流程',
                    '设计原则': '简化交互原则',
                    '检查项': '检查提交→审核→通过/驳回→通知的审批流程',
                    '优先级': '中',
                    '预期结果/设计标准': '状态流转清晰，审批意见可填写，审批结果有通知'
                },
                {
                    '页面/模块': '场景流程',
                    '检查点': '搜索筛选流程',
                    '设计原则': '预置信息与快捷操作原则',
                    '检查项': '检查输入条件→搜索→结果展示→详情查看的流程',
                    '优先级': '中',
                    '预期结果/设计标准': '搜索条件可保存，结果可排序筛选，详情可返回列表'
                },
                {
                    '页面/模块': '场景流程',
                    '检查点': '状态流转',
                    '设计原则': '交互与反馈原则',
                    '检查项': '检查数据状态的流转过程（如草稿→待审核→已发布）',
                    '优先级': '高',
                    '预期结果/设计标准': '状态变化有明确的视觉标识，状态流转符合业务逻辑，不可逆状态有二次确认'
                }
            ],
            '异常场景': [
                {
                    '页面/模块': '异常场景',
                    '检查点': '必填项验证',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查表单必填项未填写时的提示',
                    '优先级': '高',
                    '预期结果/设计标准': '必填项未填提示"该字段不能为空"，提示位置在字段下方，红色文字'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '格式验证',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查邮箱、手机号、身份证等格式验证',
                    '优先级': '高',
                    '预期结果/设计标准': '格式错误提示具体要求，如"请输入正确的邮箱格式"'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '长度限制',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查输入内容超出长度限制时的处理',
                    '优先级': '中',
                    '预期结果/设计标准': '超出长度时无法继续输入，或显示"已超出X个字符"提示'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '特殊字符处理',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查输入特殊字符时的验证和提示',
                    '优先级': '中',
                    '预期结果/设计标准': '不允许的特殊字符提示"不能包含特殊字符"，允许的字符正常输入'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '网络超时',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查网络请求超时时的处理',
                    '优先级': '高',
                    '预期结果/设计标准': '超时后显示"网络请求超时，请重试"，提供重试按钮'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '网络断开',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查网络断开时的处理',
                    '优先级': '高',
                    '预期结果/设计标准': '显示"网络连接失败"提示，提供重新连接按钮'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '服务器错误',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查服务器返回500、502等错误时的处理',
                    '优先级': '高',
                    '预期结果/设计标准': '显示友好的错误页面，提示"服务器繁忙，请稍后再试"'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '权限不足',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查无权限访问时的处理',
                    '优先级': '高',
                    '预期结果/设计标准': '跳转到403页面，提示"您没有权限访问该页面"'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '登录过期',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查登录过期或Token失效时的处理',
                    '优先级': '高',
                    '预期结果/设计标准': '自动跳转到登录页，提示"登录已过期，请重新登录"'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '空数据状态',
                    '设计原则': '引导与帮助原则',
                    '检查项': '检查列表、表格等无数据时的显示',
                    '优先级': '中',
                    '预期结果/设计标准': '显示空状态图标和文案"暂无数据"，提供创建或刷新按钮'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '数据加载失败',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查数据加载失败时的处理',
                    '优先级': '高',
                    '预期结果/设计标准': '显示"数据加载失败"提示，提供重新加载按钮'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '并发操作冲突',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查多人同时编辑同一数据时的处理',
                    '优先级': '中',
                    '预期结果/设计标准': '提示"数据已被他人修改"，提供刷新或强制保存选项'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '重复提交',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查防止重复提交的机制',
                    '优先级': '高',
                    '预期结果/设计标准': '提交后按钮禁用，显示Loading，防止重复点击'
                },
                {
                    '页面/模块': '异常场景',
                    '检查点': '极限数据量',
                    '设计原则': '预置信息与快捷操作原则',
                    '检查项': '检查大数据量（如10000+条记录）时的表现',
                    '优先级': '中',
                    '预期结果/设计标准': '使用分页或虚拟滚动，页面不卡顿，加载时间<3秒'
                }
            ],
            '上下游验证': [
                {
                    '页面/模块': '上下游验证',
                    '检查点': '页面间参数传递',
                    '设计原则': '简化交互原则',
                    '检查项': '检查从A页面跳转到B页面时参数是否正确传递',
                    '优先级': '高',
                    '预期结果/设计标准': '参数完整传递，B页面正确接收并使用参数'
                },
                {
                    '页面/模块': '上下游验证',
                    '检查点': '数据回显',
                    '设计原则': '预置信息与快捷操作原则',
                    '检查项': '检查编辑页面是否正确回显原有数据',
                    '优先级': '高',
                    '预期结果/设计标准': '所有字段数据准确回显，包括下拉框、单选框、复选框的选中状态'
                },
                {
                    '页面/模块': '上下游验证',
                    '检查点': '数据同步',
                    '设计原则': '数据与文案一致性原则',
                    '检查项': '检查在A页面操作后，B页面的数据是否同步更新',
                    '优先级': '高',
                    '预期结果/设计标准': '操作后相关页面数据实时更新，无需手动刷新'
                },
                {
                    '页面/模块': '上下游验证',
                    '检查点': '列表与详情一致性',
                    '设计原则': '数据与文案一致性原则',
                    '检查项': '检查列表页和详情页显示的数据是否一致',
                    '优先级': '高',
                    '预期结果/设计标准': '列表页和详情页数据完全一致，包括状态、时间等字段'
                },
                {
                    '页面/模块': '上下游验证',
                    '检查点': '编辑前后一致性',
                    '设计原则': '数据与文案一致性原则',
                    '检查项': '检查编辑保存后，数据是否按预期更新',
                    '优先级': '高',
                    '预期结果/设计标准': '编辑的字段正确更新，未编辑的字段保持不变'
                },
                {
                    '页面/模块': '上下游验证',
                    '检查点': '缓存处理',
                    '设计原则': '交互与反馈原则',
                    '检查项': '检查数据缓存、缓存更新、缓存失效的处理',
                    '优先级': '中',
                    '预期结果/设计标准': '数据更新后缓存及时刷新，缓存失效时重新请求'
                },
                {
                    '页面/模块': '上下游验证',
                    '检查点': '消息通知',
                    '设计原则': '交互与反馈原则',
                    '检查项': '检查操作后的消息推送、通知展示',
                    '优先级': '中',
                    '预期结果/设计标准': '操作成功后有消息通知，通知内容准确，可点击查看详情'
                },
                {
                    '页面/模块': '上下游验证',
                    '检查点': '关联数据更新',
                    '设计原则': '数据与文案一致性原则',
                    '检查项': '检查主数据变更后，关联数据是否正确更新',
                    '优先级': '高',
                    '预期结果/设计标准': '主数据变更后，所有关联数据同步更新，无遗漏'
                },
                {
                    '页面/模块': '上下游验证',
                    '检查点': '接口请求参数',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查前端发送的接口请求参数是否正确',
                    '优先级': '中',
                    '预期结果/设计标准': '请求参数完整、格式正确、必填参数不为空'
                },
                {
                    '页面/模块': '上下游验证',
                    '检查点': '接口响应处理',
                    '设计原则': '异常与负向流程验证原则',
                    '检查项': '检查前端对接口响应数据的处理',
                    '优先级': '高',
                    '预期结果/设计标准': '响应数据正确解析，错误码正确处理，异常情况有友好提示'
                },
                {
                    '页面/模块': '上下游验证',
                    '检查点': '跨页面影响',
                    '设计原则': '数据与文案一致性原则',
                    '检查项': '检查在A页面操作后，对其他相关页面的影响',
                    '优先级': '中',
                    '预期结果/设计标准': '操作影响范围明确，相关页面数据正确更新，无副作用'
                }
            ]
        }
        
        for category in categories:
            if category in category_templates:
                category_cases.extend(category_templates[category])
        
        return category_cases